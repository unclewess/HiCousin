generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  clerkId       String    @unique @map("clerk_id")
  email         String
  fullName      String?   @map("full_name")
  phoneNumber   String?   @map("phone_number")
  avatarUrl     String?   @map("avatar_url")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @default(now()) @updatedAt @map("updated_at")

  createdFamilies  Family[]            @relation("CreatedBy")
  memberships      FamilyMember[]
  contributions    Contribution[]
  streaks          Streak[]
  proofs           ProofOfPayment[]
  notifications    Notification[]
  beneficiaryProofs ProofBeneficiary[]

  @@map("users")
}

model Family {
  id                      String    @id @default(uuid())
  name                    String
  code                    String    @unique
  createdBy               String?   @map("created_by")
  baseShareValue          Decimal   @default(100.00) @map("base_share_value") @db.Decimal(10, 2)
  onTimeBonusPercent      Decimal   @default(2.00) @map("on_time_bonus_percent") @db.Decimal(5, 2)
  streakBonusPercent      Decimal   @default(5.00) @map("streak_bonus_percent") @db.Decimal(5, 2)
  contributionDeadlineDay Int       @default(5) @map("contribution_deadline_day")
  contributionFrequency   String    @default("MONTHLY") @map("contribution_frequency")
  createdAt               DateTime  @default(now()) @map("created_at")
  updatedAt               DateTime  @default(now()) @updatedAt @map("updated_at")

  creator       User?          @relation("CreatedBy", fields: [createdBy], references: [id])
  members       FamilyMember[]
  contributions Contribution[]
  monthlyTargets MonthlyTarget[]
  campaigns     Campaign[]
  expenses      Expense[]
  proofs        ProofOfPayment[]

  @@map("families")
}

model FamilyMember {
  id        String   @id @default(uuid())
  familyId  String   @map("family_id")
  userId    String   @map("user_id")
  role      String   @default("MEMBER")
  joinedAt  DateTime @default(now()) @map("joined_at")
  status    String   @default("ACTIVE")

  family    Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaignParticipations CampaignParticipant[]

  @@unique([familyId, userId])
  @@map("family_members")
}

model Contribution {
  id                String   @id @default(uuid())
  familyId          String   @map("family_id")
  userId            String   @map("user_id")
  campaignId        String?  @map("campaign_id")
  amount            Decimal  @db.Decimal(10, 2)
  shares            Decimal  @db.Decimal(10, 2)
  baseShares        Decimal  @default(0) @map("base_shares") @db.Decimal(10, 2)
  onTimeBonus       Decimal  @default(0) @map("on_time_bonus") @db.Decimal(10, 2)
  streakBonus       Decimal  @default(0) @map("streak_bonus") @db.Decimal(10, 2)
  contributionMonth DateTime @map("contribution_month") @db.Date // First day of month
  paidAt            DateTime? @map("paid_at")
  status            String   @default("PENDING")
  notes             String?
  verifiedBy        String?  @map("verified_by")
  createdAt         DateTime @default(now()) @map("created_at")

  family      Family            @relation(fields: [familyId], references: [id], onDelete: Cascade)
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaign    Campaign?         @relation(fields: [campaignId], references: [id])
  proof       ProofOfPayment?
  beneficiary ProofBeneficiary?

  @@map("contributions")
}

model MonthlyTarget {
  id           String   @id @default(uuid())
  familyId     String   @map("family_id")
  year         Int
  month        Int
  targetAmount Decimal  @map("target_amount") @db.Decimal(10, 2)

  family       Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@unique([familyId, year, month])
  @@map("monthly_targets")
}

model Streak {
  id                    String   @id @default(uuid())
  userId                String   @map("user_id")
  currentStreak         Int      @default(0) @map("current_streak")
  longestStreak         Int      @default(0) @map("longest_streak")
  lastContributionMonth DateTime? @map("last_contribution_month") @db.Date

  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId])
  @@map("streaks")
}

model Campaign {
  id              String   @id @default(uuid())
  familyId        String   @map("family_id")
  name            String
  description     String?
  targetAmount    Decimal? @map("target_amount") @db.Decimal(10, 2)
  minContribution Decimal? @map("min_contribution") @db.Decimal(10, 2)
  deadline        DateTime?
  status          String   @default("ACTIVE") // ACTIVE, COMPLETED, ARCHIVED
  type            String   @default("ADHOC") // MONTHLY, ADHOC
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @default(now()) @updatedAt @map("updated_at")
  reconciliationNotes String? @map("reconciliation_notes")

  family        Family                @relation(fields: [familyId], references: [id], onDelete: Cascade)
  participants  CampaignParticipant[]
  contributions Contribution[]
  expenses      Expense[]
  proofs        ProofOfPayment[]

  @@map("campaigns")
}

model CampaignParticipant {
  id             String   @id @default(uuid())
  campaignId     String   @map("campaign_id")
  familyMemberId String   @map("family_member_id")
  joinedAt       DateTime @default(now()) @map("joined_at")

  campaign     Campaign     @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  familyMember FamilyMember @relation(fields: [familyMemberId], references: [id], onDelete: Cascade)

  @@unique([campaignId, familyMemberId])
  @@map("campaign_participants")
}

model Expense {
  id          String   @id @default(uuid())
  familyId    String   @map("family_id")
  campaignId  String?  @map("campaign_id")
  description String
  amount      Decimal  @db.Decimal(10, 2)
  date        DateTime @db.Date
  category    String?
  createdBy   String   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")

  family   Family    @relation(fields: [familyId], references: [id], onDelete: Cascade)
  campaign Campaign? @relation(fields: [campaignId], references: [id])

  @@map("expenses")
}

model ProofOfPayment {
  id                String    @id @default(uuid())
  familyId          String    @map("family_id")
  userId            String    @map("user_id")
  amount            Decimal   @db.Decimal(10, 2)
  currency          String    @default("KES")
  paymentChannel    String    @map("payment_channel") // MPESA, BANK, CASH
  transactionRef    String?   @map("transaction_ref") // Optional for proofless claims
  paymentDate       DateTime  @map("payment_date")
  
  // Message-based proof fields
  rawMessage        String?   @map("raw_message") @db.Text // Encrypted SMS/WhatsApp text
  messageHash       String?   @map("message_hash") // SHA-256 for duplicate detection
  parserConfidence  Decimal?  @map("parser_confidence") @db.Decimal(3, 2) // 0.00-1.00
  
  // Image-based proof (now optional)
  imageUrl          String?   @map("image_url")
  
  // Fraud detection
  fraudScore        Int?      @default(0) @map("fraud_score") // 0-100
  isProofless       Boolean   @default(false) @map("is_proofless") // Manual entry without proof
  
  // Status and verification
  status            String    @default("PENDING") // PENDING, APPROVED, REJECTED, DISPUTED, ESCALATED, UNVERIFIED_CLAIM
  rejectionReason   String?   @map("rejection_reason")
  verifiedBy        String?   @map("verified_by")
  verifiedAt        DateTime? @map("verified_at")
  
  // Multi-beneficiary support
  amountAllocated   Decimal?  @map("amount_allocated") @db.Decimal(10, 2) // Total allocated to beneficiaries
  
  // Legacy single contribution (deprecated for multi-beneficiary)
  contributionId    String?   @unique @map("contribution_id")
  
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @default(now()) @updatedAt @map("updated_at")

  family        Family              @relation(fields: [familyId], references: [id], onDelete: Cascade)
  user          User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  contribution  Contribution?       @relation(fields: [contributionId], references: [id])
  beneficiaries ProofBeneficiary[]
  auditLogs     AuditLog[]
  campaignId    String?   @map("campaign_id")
  campaign      Campaign? @relation(fields: [campaignId], references: [id])

  @@index([messageHash])
  @@index([transactionRef])
  @@index([status])
  @@index([familyId, status])
  @@map("proofs_of_payment")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String   // PROOF_SUBMITTED, PROOF_APPROVED, PROOF_REJECTED
  message   String
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model ProofBeneficiary {
  id              String   @id @default(uuid())
  proofId         String   @map("proof_id")
  userId          String   @map("user_id")
  allocatedAmount Decimal  @map("allocated_amount") @db.Decimal(10, 2)
  contributionId  String?  @unique @map("contribution_id") // Created on approval
  createdAt       DateTime @default(now()) @map("created_at")

  proof        ProofOfPayment @relation(fields: [proofId], references: [id], onDelete: Cascade)
  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  contribution Contribution?  @relation(fields: [contributionId], references: [id])

  @@index([proofId])
  @@index([userId])
  @@map("proof_beneficiaries")
}

model AuditLog {
  id            String   @id @default(uuid())
  proofId       String   @map("proof_id")
  action        String   // CREATED, EDITED, APPROVED, REJECTED, DISPUTED, OVERRIDDEN, ESCALATED
  performedBy   String   @map("performed_by") // User ID
  previousValue String?  @map("previous_value") @db.Text // JSON snapshot
  newValue      String?  @map("new_value") @db.Text // JSON snapshot
  reason        String?  // Optional reason for action
  createdAt     DateTime @default(now()) @map("created_at")

  proof ProofOfPayment @relation(fields: [proofId], references: [id], onDelete: Cascade)

  @@index([proofId])
  @@index([performedBy])
  @@index([action])
  @@map("audit_logs")
}
